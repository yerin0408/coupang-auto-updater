import os
import hmac
import hashlib
import time
import requests
from bs4 import BeautifulSoup
import json
import datetime
from datetime import timezone

# --- ì„¤ì •ê°’ ---
ACCESS_KEY = os.environ.get('COUPANG_ACCESS_KEY')
SECRET_KEY = os.environ.get('COUPANG_SECRET_KEY')
VENDOR_ID = "A00835730"  # ë³¸ì¸ ì¿ íŒ¡ íŒë§¤ì ID (WING ë¡œê·¸ì¸ ID)
IMAGE_FIXED_URL = "https://gi.esmplus.com/na100shop/mall/DAY_260205.jpg" # ë§¤ì£¼ êµì²´í•  ì´ë¯¸ì§€ì˜ ê³ ì • URL

DOMAIN = "https://api-gateway.coupang.com"

# --- API ì„œëª… ìƒì„± í•¨ìˆ˜ ---
def generate_signature(method, path, secret_key, access_key, query=""):
    now = datetime.datetime.now(timezone.utc)
    timestamp = now.strftime("%y%m%dT%H%M%S") + "Z"
    message = timestamp + method + path + query
    signature = hmac.new(secret_key.encode('utf-8'), message.encode('utf-8'), hashlib.sha256).hexdigest()
    return f"CEA algorithm=HmacSHA256, access-key={access_key}, signed-date={timestamp}, signature={signature}"

# --- 1. íŒë§¤ ì¤‘ì¸ ëª¨ë“  ìƒí’ˆ ID ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (ê³µì‹ ë¬¸ì„œ ê¸°ë°˜ìœ¼ë¡œ ì™„ë²½ ìˆ˜ì •) ---
def get_all_product_ids():
    print("1. 'ìƒí’ˆ ëª©ë¡ í˜ì´ì§• ì¡°íšŒ' APIë¡œ ì¡°íšŒë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...")
    product_ids = []
    next_token = "1"  # ê³µì‹ ë¬¸ì„œì— ë”°ë¼ ì²« í˜ì´ì§€ëŠ” "1"ë¡œ ì‹œì‘

    path = "/v2/providers/seller_api/apis/api/v1/marketplace/seller-products"

    while next_token:
        # ê³µì‹ ë¬¸ì„œì— ëª…ì‹œëœ íŒŒë¼ë¯¸í„° ì´ë¦„ì„ ì •í™•íˆ ì‚¬ìš©í•©ë‹ˆë‹¤.
        query_for_signature = f"vendorId={VENDOR_ID}&maxPerPage=100&nextToken={next_token}"
        query_for_request = f"?{query_for_signature}"

        try:
            auth = generate_signature("GET", path, SECRET_KEY, ACCESS_KEY, query_for_signature)
            # ì´ APIëŠ” X-VENDOR-ID í—¤ë”ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            headers = {"Authorization": auth}

            response = requests.get(DOMAIN + path + query_for_request, headers=headers)
            response.raise_for_status()
            data = response.json()

            products_on_page = data.get('data', [])
            if not products_on_page:
                break

            for item in products_on_page:
                product_ids.append(item['sellerProductId'])

            print(f"   - ìƒí’ˆ {len(products_on_page)}ê°œ ë°œê²¬. (ì´ {len(product_ids)}ê°œ)")

            # ë‹¤ìŒ í˜ì´ì§€ë¥¼ ìœ„í•´ ì‘ë‹µì— í¬í•¨ëœ nextToken ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
            next_token = data.get('nextToken')
            if not next_token: # nextTokenì´ ë¹„ì–´ìˆìœ¼ë©´ ë§ˆì§€ë§‰ í˜ì´ì§€ì´ë¯€ë¡œ ì¢…ë£Œ
                break

            time.sleep(0.5)

        except requests.exceptions.HTTPError as e:
            print(f"ìƒí’ˆ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: {e.response.text}")
            return []

    print(f"ì´ {len(product_ids)}ê°œì˜ ìƒí’ˆ IDë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.")
    return product_ids

# --- (ì´í•˜ ë‚˜ë¨¸ì§€ ì½”ë“œëŠ” ì´ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤) ---

# --- 2. íŠ¹ì • ìƒí’ˆì˜ ì „ì²´ JSON ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ ---
def get_product_full_json(product_id):
    path = f"/v2/providers/seller_api/apis/api/v1/marketplace/seller-products/{product_id}"
    try:
        auth = generate_signature("GET", path, SECRET_KEY, ACCESS_KEY)
        response = requests.get(DOMAIN + path, headers={"Authorization": auth})
        response.raise_for_status()
        return response.json().get('data', {})
    except requests.exceptions.HTTPError as e:
        print(f"ìƒí’ˆ ID {product_id} ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: {e.response.text}")
        return None

# --- 3. ìƒí’ˆ ìˆ˜ì • ìš”ì²­ í•¨ìˆ˜ ---
def request_product_update(product_id, image_url):
    print(f"\n--- ìƒí’ˆ ID {product_id} ì—…ë°ì´íŠ¸ ì‘ì—… ì‹œì‘ ---")
    product_json = get_product_full_json(product_id)
    if not product_json: return
    try:
        is_modified = False
        for item in product_json.get('items', []):
            for content_block in item.get('contents', []):
                if content_block.get('contentsType') == 'HTML':
                    for detail in content_block.get('contentDetails', []):
                        soup = BeautifulSoup(detail.get('content', ''), 'lxml')
                        if soup.find('img'):
                            soup.find('img')['src'] = image_url
                            detail['content'] = str(soup)
                            is_modified = True
        if not is_modified:
            print("   - ìˆ˜ì •í•  ì´ë¯¸ì§€ë¥¼ ì°¾ì§€ ëª»í•´ ê±´ë„ˆëœë‹ˆë‹¤.")
            return

        keys_to_remove = ["statusName", "productId", "mdId", "mdName", "contributorType", "status", "roleCode", "trackingId"]
        for key in keys_to_remove:
            if key in product_json: del product_json[key]
        for item in product_json.get('items', []):
            item_keys_to_remove = ["vendorItemId", "itemId", "isAutoGenerated"]
            for key in item_keys_to_remove:
                if key in item: del item[key]

        product_json['requested'] = True

        path_put = "/v2/providers/seller_api/apis/api/v1/marketplace/seller-products"
        auth_put = generate_signature("PUT", path_put, SECRET_KEY, ACCESS_KEY)
        headers = {"Authorization": auth_put, "Content-Type": "application/json", "X-VENDOR-ID": VENDOR_ID}

        response_put = requests.put(DOMAIN + path_put, headers=headers, data=json.dumps(product_json))
        response_put.raise_for_status()
        print(f"ìˆ˜ì • ë° ìŠ¹ì¸ ìš”ì²­ ì„±ê³µ!")
    except Exception as e:
        print(f"ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

# --- ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜ ---
def main():
    print("ì¿ íŒ¡ ì „ì²´ ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ìë™í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.")
    product_ids = get_all_product_ids()
    if not product_ids:
        print("ì‘ì—…í•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. ì¢…ë£Œí•©ë‹ˆë‹¤.")
        return

    cache_buster = f"?v={int(time.time())}"
    final_image_url = IMAGE_FIXED_URL + cache_buster
    print(f"\"ì ìš©í•  ì´ë¯¸ì§€ URL: {final_image_url}\n")

    for pid in product_ids:
        request_product_update(pid, final_image_url)
        time.sleep(1)

    print("\nğŸ‰ ëª¨ë“  ìƒí’ˆì— ëŒ€í•œ ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì¿ íŒ¡ WINGì—ì„œ ìµœì¢… ìŠ¹ì¸ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")

if __name__ == "__main__":
    main()
