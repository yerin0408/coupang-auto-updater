# test_update_final_clean.py
import hmac
import hashlib
import requests
import json
import datetime
from datetime import timezone
from bs4 import BeautifulSoup

# --- ğŸˆ ë©”ëª¨ì¥ì— ë³µì‚¬í•´ ë‘” ê¹¨ë—í•œ í‚¤ë¥¼ ë‹¤ì‹œ í•œë²ˆ ì •í™•í•˜ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš” ---
ACCESS_KEY = "39acc047-446a-4d29-a209-c00be1d886fd"
SECRET_KEY = "a9ee22722649b6e6c2b2a5c1b9ae8900af76d143"
VENDOR_ID = "A00835730"
TEST_PRODUCT_ID = 15494346373  # í…ŒìŠ¤íŠ¸í•  ìƒí’ˆ ID
NEW_IMAGE_URL = "https://gi.esmplus.com/na100shop/mall/DAY.jpg"

DOMAIN = "https://api-gateway.coupang.com"

# --- API ì„œëª… ìƒì„± í•¨ìˆ˜ ---
def generate_signature(method, path, secret_key, access_key, query=""):
    now = datetime.datetime.now(timezone.utc)
    timestamp = now.strftime("%y%m%dT%H%M%S") + "Z"
    message = timestamp + method + path + query
    signature = hmac.new(secret_key.encode('utf-8'), message.encode('utf-8'), hashlib.sha256).hexdigest()
    return f"CEA algorithm=HmacSHA256, access-key={access_key}, signed-date={timestamp}, signature={signature}"

# --- 1. ìƒí’ˆ ì •ë³´ ì¡°íšŒ í•¨ìˆ˜ ---
def get_product_full_json(product_id):
    path = f"/v2/providers/seller_api/apis/api/v1/marketplace/seller-products/{product_id}"
    try:
        auth = generate_signature("GET", path, SECRET_KEY, ACCESS_KEY)
        response = requests.get(DOMAIN + path, headers={"Authorization": auth})
        response.raise_for_status()
        return response.json().get('data', {})
    except requests.exceptions.HTTPError as e:
        print(f"ğŸ”¥ ìƒí’ˆ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: {e.response.text}")
        return None

# --- 2. ìƒí’ˆ ìˆ˜ì • ìš”ì²­ í•¨ìˆ˜ ---
def request_product_update(product_id, image_url):
    product_json = get_product_full_json(product_id)
    if not product_json: return

    try:
        is_modified = False
        for item in product_json.get('items', []):
            for content_block in item.get('contents', []):
                if content_block.get('contentsType') == 'HTML':
                    for detail in content_block.get('contentDetails', []):
                        soup = BeautifulSoup(detail.get('content', ''), 'lxml')
                        if soup.find('img'):
                            soup.find('img')['src'] = image_url
                            detail['content'] = str(soup)
                            is_modified = True

        if not is_modified:
            print("ìˆ˜ì •í•  ì´ë¯¸ì§€ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
            return

        keys_to_remove_from_root = ["statusName", "productId", "mdId", "mdName", "contributorType", "status", "roleCode", "trackingId"]
        for key in keys_to_remove_from_root:
            if key in product_json: del product_json[key]

        for item in product_json.get('items', []):
            keys_to_remove_from_item = ["vendorItemId", "itemId", "isAutoGenerated"]
            for key in keys_to_remove_from_item:
                if key in item: del item[key]

        product_json['requested'] = True

        path_put = "/v2/providers/seller_api/apis/api/v1/marketplace/seller-products"
        auth_put = generate_signature("PUT", path_put, SECRET_KEY, ACCESS_KEY)
        headers = {"Authorization": auth_put, "Content-Type": "application/json", "X-VENDOR-ID": VENDOR_ID}

        response_put = requests.put(DOMAIN + path_put, headers=headers, data=json.dumps(product_json))
        response_put.raise_for_status()
        print(f"âœ… ìˆ˜ì • ë° ìŠ¹ì¸ ìš”ì²­ ì„±ê³µ! ì‘ë‹µ: {response_put.text}")

    except requests.exceptions.HTTPError as e:
        print(f"ğŸ”¥ ìˆ˜ì • ìš”ì²­ ì‹¤íŒ¨: {e.response.text}")
    except Exception as e:
        print(f"ğŸ”¥ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

# --- ì‹¤í–‰ ---
if __name__ == "__main__":
    request_product_update(TEST_PRODUCT_ID, NEW_IMAGE_URL)